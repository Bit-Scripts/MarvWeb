#!/usr/bin/env node
const http = require('http');
const { Server } = require('socket.io');

const app = require('../app');
const { db } = require('../db');

var port = normalizePort(process.env.PORT || '3017');
app.set('port', port);

var server = http.createServer(app);

const io = new Server(server, {
  cors: {
    origin: ['https://marv-bot.fr', 'http://marv-bot.fr', 'http://localhost:3017'],
    methods: ['GET', 'POST'],
    credentials: true
  },
  transports: ['websocket', 'polling']
});

io.on('connection', (socket) => {
  console.log(
    '✅ socket connected',
    socket.id,
    'auth.token=',
    socket.handshake.auth?.token?.slice(0, 8)
  );

  socket.on('marv', (data) => {
    const token = socket.handshake.auth?.token || data?.token;

    if (!token) {
      socket.emit('marv', 'Erreur: Session invalide. Recharge la page.');
      return;
    }

    db.get(`SELECT * FROM users WHERE token = ?`, [token], (err, user) => {
      if (err) {
        console.error('❌ DB', err);
        socket.emit('marv', 'Erreur serveur.');
        return;
      }
      if (!user) {
        socket.emit('marv', 'Erreur: Session invalide. Recharge la page.');
        return;
      }

      db.run(
        `INSERT INTO conversations (token, message, latitude, longitude, timezone, hashed_ip)
         VALUES (?, ?, ?, ?, ?, ?)`,
        [token, data.message, data.latitude, data.longitude, data.tz, data.ip],
        function (err) {
          if (err) {
            console.error('❌ insert conv', err);
            socket.emit('marv', 'Erreur sauvegarde.');
            return;
          }
          socket.emit('marv', `ok (id=${this.lastID})`);
        }
      );
    });
  });

  socket.on('disconnect', (reason) => {
    console.log('❌ socket disconnected', socket.id, reason);
  });
});

server.listen(port, '0.0.0.0', () => {
  console.log('Listening on port', port);
});

function normalizePort(val) {
  var port = parseInt(val, 10);
  if (isNaN(port)) return val;
  if (port >= 0) return port;
  return false;
}
