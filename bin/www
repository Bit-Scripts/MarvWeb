#!/usr/bin/env node
const http = require('http');
const { Server } = require('socket.io');

const { Marv } = require('../marv');

const app = require('../app');
const { db } = require('../db');

var port = normalizePort(process.env.PORT || '3017');
app.set('port', port);

var server = http.createServer(app);

const io = new Server(server, {
  cors: {
    origin: ['https://marv-bot.fr', 'http://marv-bot.fr', 'http://localhost:3017'],
    methods: ['GET', 'POST'],
    credentials: true
  },
  transports: ['websocket', 'polling']
});

io.on('connection', (socket) => {
  console.log(
    'âœ… socket connected',
    socket.id,
    'auth.token=',
    socket.handshake.auth?.token?.slice(0, 8)
  );

  socket.on('marv', async (data) => {
    const token = socket.handshake.auth?.token || data?.token;
    if (!token) return socket.emit('marv', 'Erreur: Session invalide. Recharge la page.');

    try {
      // log entree
      console.log('ğŸ“¨ marv event:', {
        token: token.slice(0, 8),
        msg: (data.message || '').slice(0, 120),
        tz: data.tz,
        lat: data.latitude,
        lon: data.longitude
      });

      // ici: appel marv.js
      const answer = await marv.handleMessage({
        token,
        message: data.message,
        tz: data.tz,
        latitude: data.latitude,
        longitude: data.longitude,
        ip: data.ip
      });

      // log sortie
      console.log('âœ… marv answer:', (answer || '').slice(0, 200));

      socket.emit('marv', answer || '(vide)');
    } catch (e) {
      console.error('âŒ marv.js crashed:', e?.stack || e);
      socket.emit('marv', 'Erreur serveur (marv.js).');
    }
  });

  socket.on('disconnect', (reason) => {
    console.log('âŒ socket disconnected', socket.id, reason);
  });
});

server.listen(port, '0.0.0.0', () => {
  console.log('Listening on port', port);
});

function normalizePort(val) {
  var port = parseInt(val, 10);
  if (isNaN(port)) return val;
  if (port >= 0) return port;
  return false;
}
