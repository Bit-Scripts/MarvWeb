#!/usr/bin/env node
const http = require('http');
const { Server } = require('socket.io');
const { Marv } = require('../marv');
const app = require('../app');
const { db } = require('../db');

var port = normalizePort(process.env.PORT || '3017');
app.set('port', port);
var server = http.createServer(app);

const io = new Server(server, {
  cors: {
    origin: ['https://marv-bot.fr', 'http://localhost:3017'],
    credentials: true
  }
});

// Middleware de sécurité : On vérifie si le token existe en DB avant de connecter
io.use((socket, next) => {
  const token = socket.handshake.auth?.token;
  if (!token || token.length < 32) return next(new Error("INVALID_TOKEN"));

  db.get(`SELECT hashed_ip FROM users WHERE token = ?`, [token], (err, row) => {
    if (err || !row) return next(new Error("SESSION_NOT_FOUND"));
    socket.hashedIP = row.hashed_ip; // On attache l'IP déjà connue au socket
    next();
  });
});

io.on('connection', (socket) => {
  const token = socket.handshake.auth?.token;

  socket.on('marv', async (data, cb) => {
    if (!token) return cb?.({ ok: false, error: 'NO_TOKEN' });

    // Utilisation de socket.hashedIP récupéré dans le middleware io.use
    db.run(
      `INSERT INTO conversations (token, message, latitude, longitude, timezone, hashed_ip)
       VALUES (?, ?, ?, ?, ?, ?)`,
      [token, data.message, data.latitude, data.longitude, data.tz, socket.hashedIP],
      async function (err) {
        if (err) return cb?.({ ok: false, error: 'DB_ERROR' });
        
        const userMsgId = this.lastID;
        cb?.({ ok: true, id: userMsgId });

        try {
          const reply = await Marv(data.message, data.tz, data.message, data.latitude, data.longitude);
          db.run(
            `INSERT INTO conversations (token, message, latitude, longitude, timezone, hashed_ip)
             VALUES (?, ?, ?, ?, ?, ?)`,
            [token, reply, data.latitude, data.longitude, data.tz, socket.hashedIP]
          );
          socket.emit('marv', reply);
        } catch (e) {
          socket.emit('marv', "Désolé, j'ai eu un souci avec l'IA.");
        }
      }
    );
  });
});

server.listen(port);

function normalizePort(val) {
  var port = parseInt(val, 10);
  if (isNaN(port)) return val;
  if (port >= 0) return port;
  return false;
}