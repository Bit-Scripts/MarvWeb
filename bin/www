#!/usr/bin/env node
const http = require('http');
const { Server } = require('socket.io');

const { Marv } = require('../marv');

const app = require('../app');
const { db } = require('../db');

var port = normalizePort(process.env.PORT || '3017');
app.set('port', port);

var server = http.createServer(app);

const io = new Server(server, {
  cors: {
    origin: ['https://marv-bot.fr', 'http://marv-bot.fr', 'http://localhost:3017'],
    methods: ['GET', 'POST'],
    credentials: true
  },
  transports: ['websocket', 'polling']
});

io.use((socket, next) => {
  const token = socket.handshake.auth?.token;
  if (!token) {
    return next(new Error("NO_TOKEN"));
  }
  next();
});

io.on('connection', (socket) => {
  console.log(
    '✅ socket connected',
    socket.id,
    'auth.token=',
    socket.handshake.auth?.token?.slice(0, 8)
  );

io.on('connection', (socket) => {
  console.log('✅ socket connected', socket.id, 'auth.token=', socket.handshake.auth?.token?.slice(0, 8));

  socket.on('marv', async (data) => {
    const token = socket.handshake.auth?.token || data?.token;

    console.log('token used:', token ? token.slice(0,8) : 'undefined');

    if (!token) {
      socket.emit('marv', 'Erreur: Session invalide. Recharge la page.');
      return;
    }

    db.get(`SELECT * FROM users WHERE token = ?`, [token], async (err, user) => {
      if (err) {
        console.error('❌ DB', err);
        socket.emit('marv', 'Erreur serveur.');
        return;
      }
      if (!user) {
        socket.emit('marv', 'Erreur: Session invalide. Recharge la page.');
        return;
      }

      // log conversation en DB (tu peux garder ca)
      db.run(
        `INSERT INTO conversations (token, message, latitude, longitude, timezone, hashed_ip)
         VALUES (?, ?, ?, ?, ?, ?)`,
        [token, data.message, data.latitude, data.longitude, data.tz, data.ip],
        async function (err2) {
          if (err2) console.error('❌ insert conv', err2);

          try {
            // IMPORTANT: ici on appelle Marv() pour obtenir une vraie reponse
            const rep = await Marv(
              data.message,             // question
              data.tz,                  // timeZon (ton code accepte int minutes ou undefined)
              data.message,             // messageClient (tu l'utilises pour actu + ville)
              data.latitude,
              data.longitude,
              null                      // customPrompt (si tu veux)
            );

            socket.emit('marv', rep || "Je n'ai pas de reponse pour l'instant.");
          } catch (e) {
            console.error('❌ Marv() crashed', e?.stack || e);
            socket.emit('marv', 'Erreur serveur (Marv).');
          }
        }
      );
    });
  });

  socket.on('disconnect', (reason) => {
    console.log('❌ socket disconnected', socket.id, reason);
  });
});

  socket.on('disconnect', (reason) => {
    console.log('❌ socket disconnected', socket.id, reason);
  });
});

server.listen(port, '0.0.0.0', () => {
  console.log('Listening on port', port);
});

function normalizePort(val) {
  var port = parseInt(val, 10);
  if (isNaN(port)) return val;
  if (port >= 0) return port;
  return false;
}
